<%- include('../layouts/main', { 
    body: `
        <div class="container-fluid py-4">
            <!-- Welcome Section -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card bg-gradient-primary text-white">
                        <div class="card-body">
                            <div class="row align-items-center">
                                <div class="col-md-8">
                                    <h2 class="card-title mb-2">
                                        ¡Hola, ${user.firstName}! 
                                        <i class="bi bi-emoji-smile ms-2"></i>
                                    </h2>
                                    <p class="card-text mb-3">
                                        Aquí tienes un resumen de tu progreso académico actual.
                                    </p>
                                    <div class="d-flex flex-wrap gap-2">
                                        <a href="/grades" class="btn btn-light">
                                            <i class="bi bi-clipboard-data me-2"></i>Ver Calificaciones
                                        </a>
                                        <a href="/evaluation-plans" class="btn btn-outline-light">
                                            <i class="bi bi-clipboard-check me-2"></i>Planes de Evaluación
                                        </a>
                                    </div>
                                </div>
                                <div class="col-md-4 text-center">
                                    <i class="bi bi-mortarboard-fill" style="font-size: 5rem; opacity: 0.7;"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Stats -->
            <div class="row mb-4">
                <div class="col-lg-3 col-md-6 mb-3">
                    <div class="card border-0 shadow-sm h-100">
                        <div class="card-body text-center">
                            <div class="d-inline-flex align-items-center justify-content-center bg-primary bg-opacity-10 rounded-circle mb-3" 
                                 style="width: 60px; height: 60px;">
                                <i class="bi bi-book text-primary" style="font-size: 1.5rem;"></i>
                            </div>
                            <h3 class="card-title text-primary">${totalSubjects || 0}</h3>
                            <p class="card-text text-muted mb-0">Materias Inscritas</p>
                        </div>
                    </div>
                </div>
                
                <div class="col-lg-3 col-md-6 mb-3">
                    <div class="card border-0 shadow-sm h-100">
                        <div class="card-body text-center">
                            <div class="d-inline-flex align-items-center justify-content-center bg-success bg-opacity-10 rounded-circle mb-3" 
                                 style="width: 60px; height: 60px;">
                                <i class="bi bi-check-circle text-success" style="font-size: 1.5rem;"></i>
                            </div>
                            <h3 class="card-title text-success">${completedSubjects || 0}</h3>
                            <p class="card-text text-muted mb-0">Materias Completadas</p>
                        </div>
                    </div>
                </div>
                
                <div class="col-lg-3 col-md-6 mb-3">
                    <div class="card border-0 shadow-sm h-100">
                        <div class="card-body text-center">
                            <div class="d-inline-flex align-items-center justify-content-center bg-info bg-opacity-10 rounded-circle mb-3" 
                                 style="width: 60px; height: 60px;">
                                <i class="bi bi-graph-up text-info" style="font-size: 1.5rem;"></i>
                            </div>
                            <h3 class="card-title text-info">${averageGrade || '--'}</h3>
                            <p class="card-text text-muted mb-0">Promedio General</p>
                        </div>
                    </div>
                </div>
                
                <div class="col-lg-3 col-md-6 mb-3">
                    <div class="card border-0 shadow-sm h-100">
                        <div class="card-body text-center">
                            <div class="d-inline-flex align-items-center justify-content-center bg-warning bg-opacity-10 rounded-circle mb-3" 
                                 style="width: 60px; height: 60px;">
                                <i class="bi bi-clock text-warning" style="font-size: 1.5rem;"></i>
                            </div>
                            <h3 class="card-title text-warning">${pendingActivities || 0}</h3>
                            <p class="card-text text-muted mb-0">Actividades Pendientes</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <!-- Recent Grades -->
                <div class="col-xl-8 mb-4">
                    <div class="card shadow-sm">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="card-title mb-0">
                                <i class="bi bi-clipboard-data me-2"></i>Calificaciones Recientes
                            </h5>
                            <a href="/grades" class="btn btn-sm btn-primary">Ver Todas</a>
                        </div>
                        <div class="card-body">
                            ${recentGrades && recentGrades.length > 0 ? `
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Materia</th>
                                                <th class="text-center">Semestre</th>
                                                <th class="text-center">Progreso</th>
                                                <th class="text-center">Nota Actual</th>
                                                <th class="text-center">Estado</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${recentGrades.slice(0, 5).map(grade => {
                                                const completedActivities = grade.activities.filter(a => a.score !== null).length;
                                                const totalActivities = grade.activities.length;
                                                const progressPercent = totalActivities > 0 
                                                    ? Math.round((completedActivities / totalActivities) * 100) : 0;
                                                
                                                const currentGrade = grade.currentGrade || 0;
                                                
                                                let statusBadge = 'bg-secondary';
                                                let statusText = 'Sin calificar';
                                                
                                                if (grade.isComplete) {
                                                    statusBadge = grade.finalGrade >= 3.0 ? 'bg-success' : 'bg-danger';
                                                    statusText = grade.finalGrade >= 3.0 ? 'Aprobada' : 'Reprobada';
                                                } else if (completedActivities > 0) {
                                                    statusBadge = 'bg-warning';
                                                    statusText = 'En progreso';
                                                }
                                                
                                                return `
                                                    <tr>
                                                        <td>
                                                            <div>
                                                                <div class="fw-medium">${grade.subjectCode}</div>
                                                                <small class="text-muted">${grade.subjectName || grade.subjectCode}</small>
                                                            </div>
                                                        </td>
                                                        <td class="text-center">
                                                            <small>${grade.semester}</small>
                                                        </td>
                                                        <td class="text-center">
                                                            <div class="progress" style="width: 60px; height: 6px;">
                                                                <div class="progress-bar ${progressPercent === 100 ? 'bg-success' : 'bg-primary'}" 
                                                                     style="width: ${progressPercent}%"></div>
                                                            </div>
                                                            <small class="text-muted">${progressPercent}%</small>
                                                        </td>
                                                        <td class="text-center">
                                                            <span class="fw-bold ${currentGrade >= 3.0 ? 'text-success' : 'text-warning'}">
                                                                ${currentGrade.toFixed(2)}
                                                            </span>
                                                        </td>
                                                        <td class="text-center">
                                                            <span class="badge ${statusBadge}">${statusText}</span>
                                                        </td>
                                                    </tr>
                                                `;
                                            }).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            ` : `
                                <div class="text-center py-4">
                                    <i class="bi bi-clipboard-x text-muted mb-3" style="font-size: 3rem;"></i>
                                    <h6 class="text-muted">No hay calificaciones registradas</h6>
                                    <p class="text-muted">Cuando tus profesores suban calificaciones, aparecerán aquí.</p>
                                </div>
                            `}
                        </div>
                    </div>
                </div>

                <!-- Performance Chart -->
                <div class="col-xl-4 mb-4">
                    <div class="card shadow-sm">
                        <div class="card-header">
                            <h5 class="card-title mb-0">
                                <i class="bi bi-pie-chart me-2"></i>Rendimiento Académico
                            </h5>
                        </div>
                        <div class="card-body">
                            <canvas id="performanceChart" width="300" height="300"></canvas>
                            
                            <div class="mt-3">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <small class="text-muted">Aprobadas</small>
                                    <span class="badge bg-success">${passedSubjects || 0}</span>
                                </div>
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <small class="text-muted">En progreso</small>
                                    <span class="badge bg-warning">${inProgressSubjects || 0}</span>
                                </div>
                                <div class="d-flex justify-content-between align-items-center">
                                    <small class="text-muted">Reprobadas</small>
                                    <span class="badge bg-danger">${failedSubjects || 0}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <!-- Upcoming Activities -->
                <div class="col-lg-6 mb-4">
                    <div class="card shadow-sm">
                        <div class="card-header">
                            <h5 class="card-title mb-0">
                                <i class="bi bi-calendar-check me-2"></i>Próximas Actividades
                            </h5>
                        </div>
                        <div class="card-body">
                            ${upcomingActivities && upcomingActivities.length > 0 ? `
                                <div class="list-group list-group-flush">
                                    ${upcomingActivities.slice(0, 5).map(activity => `
                                        <div class="list-group-item px-0 py-3 border-start-0 border-end-0">
                                            <div class="d-flex w-100 justify-content-between align-items-start">
                                                <div class="flex-grow-1">
                                                    <h6 class="mb-1">${activity.name}</h6>
                                                    <p class="mb-1 text-muted small">${activity.subjectCode} - ${activity.type}</p>
                                                    <small class="text-primary fw-medium">${activity.percentage}% del total</small>
                                                </div>
                                                <div class="text-end">
                                                    ${activity.dueDate ? `
                                                        <small class="text-muted">
                                                            ${new Date(activity.dueDate).toLocaleDateString('es-ES', {
                                                                month: 'short',
                                                                day: 'numeric'
                                                            })}
                                                        </small>
                                                    ` : ''}
                                                    <div class="mt-1">
                                                        <span class="badge bg-light text-dark">${activity.subjectCode}</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                                
                                ${upcomingActivities.length > 5 ? `
                                    <div class="text-center mt-3">
                                        <small class="text-muted">Y ${upcomingActivities.length - 5} actividades más...</small>
                                    </div>
                                ` : ''}
                            ` : `
                                <div class="text-center py-4">
                                    <i class="bi bi-calendar-x text-muted mb-3" style="font-size: 3rem;"></i>
                                    <h6 class="text-muted">No hay actividades próximas</h6>
                                    <p class="text-muted">¡Estás al día con tus evaluaciones!</p>
                                </div>
                            `}
                        </div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="col-lg-6 mb-4">
                    <div class="card shadow-sm">
                        <div class="card-header">
                            <h5 class="card-title mb-0">
                                <i class="bi bi-lightning me-2"></i>Acciones Rápidas
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-6">
                                    <a href="/grades" class="btn btn-outline-primary w-100 text-start">
                                        <i class="bi bi-clipboard-data me-2"></i>
                                        <div>
                                            <div class="fw-medium">Mis Calificaciones</div>
                                            <small class="text-muted">Ver todas mis notas</small>
                                        </div>
                                    </a>
                                </div>
                                <div class="col-6">
                                    <a href="/evaluation-plans" class="btn btn-outline-info w-100 text-start">
                                        <i class="bi bi-clipboard-check me-2"></i>
                                        <div>
                                            <div class="fw-medium">Planes de Evaluación</div>
                                            <small class="text-muted">Ver criterios de evaluación</small>
                                        </div>
                                    </a>
                                </div>
                                <div class="col-6">
                                    <button onclick="calculateProjections()" class="btn btn-outline-success w-100 text-start">
                                        <i class="bi bi-graph-up me-2"></i>
                                        <div>
                                            <div class="fw-medium">Proyecciones</div>
                                            <small class="text-muted">Calcular posibles notas</small>
                                        </div>
                                    </button>
                                </div>
                                <div class="col-6">
                                    <button onclick="exportData()" class="btn btn-outline-secondary w-100 text-start">
                                        <i class="bi bi-download me-2"></i>
                                        <div>
                                            <div class="fw-medium">Exportar Datos</div>
                                            <small class="text-muted">Descargar reporte</small>
                                        </div>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recent Notifications -->
            <div class="row">
                <div class="col-12">
                    <div class="card shadow-sm">
                        <div class="card-header">
                            <h5 class="card-title mb-0">
                                <i class="bi bi-bell me-2"></i>Notificaciones Recientes
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle me-2"></i>
                                Las notificaciones aparecerán aquí cuando estén disponibles.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <script>
            document.addEventListener('DOMContentLoaded', function() {
                initPerformanceChart();
            });

            function initPerformanceChart() {
                const ctx = document.getElementById('performanceChart').getContext('2d');
                
                const passed = ${passedSubjects || 0};
                const inProgress = ${inProgressSubjects || 0};
                const failed = ${failedSubjects || 0};
                
                new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Aprobadas', 'En Progreso', 'Reprobadas'],
                        datasets: [{
                            data: [passed, inProgress, failed],
                            backgroundColor: ['#28a745', '#ffc107', '#dc3545'],
                            borderWidth: 2,
                            borderColor: '#fff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        }
                    }
                });
            }

            function calculateProjections() {
                alert('Funcionalidad de proyecciones pendiente de implementación');
                // TODO: Implementar cálculo de proyecciones generales
            }

            function exportData() {
                alert('Funcionalidad de exportación pendiente de implementación');
                // TODO: Implementar exportación de datos del estudiante
            }
        </script>
    `
}) %> 